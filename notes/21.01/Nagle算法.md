### Small Packet Problem

在使用一些协议通讯的时候，比如Telnet，会有一个字节字节的发送的情景，每次发送一个字节的有用数据，就会产生41个字节长的分组，20个字节的IP Header 和 20个字节的TCP Header，这就导致了1个字节的有用信息要浪费掉40个字节的头部信息，这是一笔巨大的字节开销，而且这种Small packet在广域网上会增加拥塞的出现。



如果解决这种问题？ Nagle就提出了一种通过减少需要通过网络发送包的数量来提高TCP/IP传输的效率，这就是Nagle算法

>  “只有收到前一数据的ACK消息时，Nagle算法才发送下一数据”

https://img-blog.csdnimg.cn/20190402084354218.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwNzMyMzUw,size_16,color_FFFFFF,t_70



TCP套接字默认使用Nagle算法交换数据，因此最大限度地进行缓冲，直到收到ACK。图左侧正是这种情况。为了发送字符串"Nagle", 将其传递到输出缓冲。这时头字符"N" 之前没有其他数据（没有需接收的ACK ), 因此立即传输。之后开始等待字符"N" 的ACK消息，等待
过程中，剩下的"agle" 填入输出缓冲。接下来，收到字符"N" 的ACK消息后，将输出缓冲的"agle" 装入一个数据包发送。也就是说，共需传递4个数据包以传输l 个字符串。
接下来分析未使用Nagl~算法时发送字符串"Nagle" 的过程。假设字符"N" 到"e" 依序传到输出缓冲。此时的发送过程与AC幻妾收与否无关，因此数据到达输出缓冲后将立即被发送出去。从图右侧可以看到，发送字符串"Nagle" 时共需10个数据包。由此可知，不使用Na.gl~算法将对网络流量(Traffic: 指网络负载或混杂程度）产生负面影响。即使只传输1 个字节的数据，其头信息都有可能是几十个字节。因此，为了提高网络传输效率，必须使用Naglej算法

**缺点：**
但Nagle算法并不是什么时候都适用。根据传输数据的特性，网络流最未受太大影响时，不使用Nagle算法要比使用它时传输速度快。
最典型的是传输大文件时，由于把数据输入到缓冲区的速度快，但是把缓冲区输出到网络上就慢，如果还要等待ACK的话，那就更慢，所以我们希望缓冲区的数据尽快发送出去，后面的数据才更好的输入到缓存区中。在这种情况下不使用Nagle算法不仅不会增加数据包的数撮， 反而会在无需等待ACK的前提下连续传输， 因此可以大大提高传输速度。